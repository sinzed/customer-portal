stages:
  - test
  - build

variables:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

backend-tests:
  stage: test
  image: python:${PYTHON_VERSION}
  before_script:
    - cd backend
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install -r requirements-test.txt
  script:
    - pytest -v
  environment:
    DATABASE_URL: sqlite+aiosqlite:///:memory:

backend-build:
  stage: build
  image: python:${PYTHON_VERSION}
  dependencies:
    - backend-tests
  before_script:
    - cd backend
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - python -c "from app.main import app; print('Backend imports successful')"

frontend-tests:
  stage: test
  image: node:${NODE_VERSION}
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm test -- --run

frontend-build:
  stage: build
  image: node:${NODE_VERSION}
  dependencies:
    - frontend-tests
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run build
  environment:
    VITE_API_URL: http://localhost:8000
